# v2.0.0 Migration Guide

Version 2.0.0 of `opgginc/laravel-mcp-server` introduces a route-first architecture and removes legacy transport/configuration paths.  
If you are upgrading from any v1.x release, complete the migration steps below.

## Breaking Changes Summary

1. **Config-driven MCP bootstrapping was removed**
   - `config/mcp-server.php` is no longer shipped or read by the package.
   - MCP routes are no longer auto-registered from config.
2. **Streamable HTTP is now the only transport**
   - Legacy SSE endpoints and adapters were removed.
   - `/your-path/sse` and `/your-path/message` are no longer available.
3. **Endpoint registration is now explicit and route-based**
   - Laravel: `Route::mcp('/mcp')`
   - Lumen: `McpRoute::register('/mcp')`
4. **Legacy tool transport methods were removed**
   - Remove `messageType(): ProcessMessageType`
   - `isStreaming(): bool` is no longer used by the runtime (remove as optional cleanup)
   - `ProcessMessageType::SSE` is removed.
5. **Tool discovery in `mcp:test-tool` is route-driven**
   - The command now reads tools from registered MCP endpoints.

## Quick Migration Checklist

1. Remove old MCP config publishing/setup logic from your app and deployment scripts.
2. Register MCP endpoint(s) directly in route files.
3. Move middleware/domain settings from config to route groups.
4. Move tool/resource/template/prompt registrations to the route builder chain.
5. Run `php artisan mcp:migrate-tools` for legacy getter renames and `messageType()` removal, then optionally remove leftover `isStreaming()` methods.
6. Update MCP client endpoints to the route path (for example, `/mcp`).
7. Verify routes and tool execution with CLI/tests.

## Config-to-Route Mapping

| v1.x config key | v2.0.0 route API |
| --- | --- |
| `server.name` | `->setName('...')` |
| `server.version` | `->setVersion('...')` |
| `server.*` (combined) | `->setServerInfo(name: ..., version: ...)` (+ optional v2 metadata: `title`, `description`, `websiteUrl`, `icons`, `instructions`) |
| `tools` | `->tools([...])` |
| `resources` | `->resources([...])` |
| `resource_templates` | `->resourceTemplates([...])` |
| `prompts` | `->prompts([...])` |
| `tool_capabilities.list_changed` | `->toolListChanged(true)` |
| `domain` | `Route::domain('api.example.com')->group(function () { Route::mcp(...); })` |
| `N/A in v1.x (new in v2 resources capabilities)` | `->resourcesSubscribe(true)->resourcesListChanged(true)` |
| `N/A in v1.x (new in v2 prompts capabilities)` | `->promptsListChanged(true)` |
| `tools_list.page_size` | `->toolsPageSize(50)` |
| `default_path` | `Route::mcp('/your-path')` path argument |
| `middlewares` | `Route::middleware([...])->group(...)` |
| `server_provider`, `sse_adapter`, `adapters` | Removed (no replacement needed) |
| `enabled` | Removed (control registration via route conditionals) |

## Before and After

### v1.x (config-driven)

```php
// config/mcp-server.php (removed in v2)
return [
    'enabled' => true,
    'server' => [
        'name' => 'Acme MCP Server',
        'version' => '1.5.2',
    ],
    'server_provider' => 'streamable_http',
    'default_path' => 'mcp',
    'middlewares' => ['auth:sanctum'],
    'tools' => [
        App\MCP\Tools\MyTool::class,
    ],
];
```

### v2.0.0 (route-driven)

```php
use Illuminate\Support\Facades\Route;
use App\MCP\Tools\MyTool;
use App\MCP\Resources\MyResource;
use App\MCP\ResourceTemplates\MyTemplate;
use App\MCP\Prompts\MyPrompt;

if (env('MCP_SERVER_ENABLED', true)) {
    Route::middleware(['auth:sanctum', 'throttle:100,1'])
        ->group(function () {
            Route::mcp('/mcp')
                ->setServerInfo(
                    name: 'Acme MCP Server',
                    version: '2.0.0',
                    title: 'Acme MCP',
                    description: 'Acme tool and data gateway',
                    websiteUrl: 'https://example.com/mcp',
                    icons: [
                        ['src' => 'https://example.com/icon.png', 'mimeType' => 'image/png', 'sizes' => ['512x512'], 'theme' => 'dark'],
                    ],
                    instructions: 'Call tools/list before tools/call.',
                )
                ->tools([MyTool::class])
                ->resources([MyResource::class])
                ->resourceTemplates([MyTemplate::class])
                ->prompts([MyPrompt::class])
                ->toolListChanged((bool) env('MCP_TOOLS_LIST_CHANGED', false))
                ->resourcesSubscribe((bool) env('MCP_RESOURCES_SUBSCRIBE', false))
                ->resourcesListChanged((bool) env('MCP_RESOURCES_LIST_CHANGED', false))
                ->promptsListChanged((bool) env('MCP_PROMPTS_LIST_CHANGED', false))
                ->toolsPageSize((int) env('MCP_TOOLS_PAGE_SIZE', 50));
        });
}
```

## Tool Interface Migration

If your tools still include legacy transport methods, run:

```bash
php artisan mcp:migrate-tools
```

This command supports v1.0.x/v1.1.x/v1.2.x tool signatures, renames legacy v1.0 getter methods, and removes obsolete `messageType()` usage while preserving backups by default. It does not remove optional `isStreaming()` methods.

### Manual example

```php
// Required removals for v2 compatibility:
// - use OPGG\LaravelMcpServer\Enums\ProcessMessageType;
// - public function messageType(): ProcessMessageType { ... }
//
// Optional cleanup (runtime no longer uses this method):
// - public function isStreaming(): bool { ... }
```

## Transport and Endpoint Notes

- MCP communication now uses Streamable HTTP endpoint(s) only.
- For each registered path, `POST /path` handles JSON-RPC requests.
- `GET /path` returns HTTP 405 by design.
- If you place routes in `routes/web.php`, ensure CSRF middleware is excluded for MCP POST requests or register MCP routes in an API context.

## Lumen Migration Note

Lumen does not expose the `Route::mcp()` macro. Use:

```php
use OPGG\LaravelMcpServer\Routing\McpRoute;
use App\MCP\Tools\MyTool;
use App\MCP\Resources\MyResource;
use App\MCP\ResourceTemplates\MyTemplate;
use App\MCP\Prompts\MyPrompt;

McpRoute::register('/mcp')
    ->setServerInfo(
        name: 'Acme MCP Server',
        version: '2.0.0',
        title: 'Acme MCP',
        description: 'Acme tool and data gateway',
        websiteUrl: 'https://example.com/mcp',
        icons: [
            ['src' => 'https://example.com/icon.png', 'mimeType' => 'image/png', 'sizes' => ['512x512'], 'theme' => 'dark'],
        ],
        instructions: 'Call tools/list before tools/call.',
    )
    ->tools([MyTool::class])
    ->resources([MyResource::class])
    ->resourceTemplates([MyTemplate::class])
    ->prompts([MyPrompt::class])
    ->toolListChanged((bool) env('MCP_TOOLS_LIST_CHANGED', false))
    ->resourcesSubscribe((bool) env('MCP_RESOURCES_SUBSCRIBE', false))
    ->resourcesListChanged((bool) env('MCP_RESOURCES_LIST_CHANGED', false))
    ->promptsListChanged((bool) env('MCP_PROMPTS_LIST_CHANGED', false))
    ->toolsPageSize((int) env('MCP_TOOLS_PAGE_SIZE', 50));
```

If you need middleware in Lumen, wrap `McpRoute::register(...)` inside router groups (for example `$router->group(['middleware' => ['auth:api']], fn () => ...)`).

## Post-Migration Verification

```bash
php artisan route:list | grep mcp
php artisan mcp:test-tool --list --endpoint=/mcp
vendor/bin/pest
vendor/bin/phpstan analyse
```

After these checks pass, your project is fully migrated to the v2.0.0 routing model.
