# v2.0.0 Migration Guide

Version 2.0.0 of `opgginc/laravel-mcp-server` introduces a route-first architecture and removes legacy transport/configuration paths.
This guide describes migration changes from v1.0.0 to v2.0.0.

## Breaking Changes Summary

1. **Config-driven MCP bootstrapping was removed**
   - `config/mcp-server.php` is no longer shipped or read by the package.
   - MCP routes are no longer auto-registered from config.
2. **Streamable HTTP is now the only transport**
   - Legacy SSE endpoints and adapters were removed.
   - `/your-path/sse` and `/your-path/message` are no longer available.
3. **Endpoint registration is now explicit and route-based**
   - Laravel: `Route::mcp('/mcp')`
   - Lumen: `McpRoute::register('/mcp')`
4. **Server metadata mutators were consolidated into `setServerInfo(...)`**
   - Route builders no longer expose `setName()`, `setVersion()`, `setTitle()`, `setDescription()`, `setWebsiteUrl()`, `setIcons()`, or `setInstructions()`.
   - Use `setServerInfo(...)` named arguments to set server metadata in one place.
5. **Legacy tool transport methods were removed**
   - Remove `messageType(): ProcessMessageType`
   - `isStreaming(): bool` is no longer used by the runtime (optional cleanup)
   - `ProcessMessageType::SSE` is removed.
6. **Tool discovery in `mcp:test-tool` is route-driven**
   - The command now reads tools from registered MCP endpoints.
7. **Package-owned environment toggles are no longer part of migration**
   - v2 endpoint behavior is configured by explicit route builder calls.
   - You can still add your own application-level route conditionals if needed.

## Quick Migration Checklist

1. Remove old MCP config publishing/setup logic from your app and deployment scripts.
2. Register MCP endpoint(s) directly in route files.
3. Replace removed server metadata mutators (`setName()` etc.) with `setServerInfo(...)`.
4. Move middleware/domain settings from config to route groups.
5. Move tool/resource/template/prompt registrations to the route builder chain.
6. Run `php artisan mcp:migrate-tools` for legacy getter renames and `messageType()` removal, then optionally remove leftover `isStreaming()` methods.
7. Update MCP client endpoints to the route path (for example, `/mcp`).
8. Verify routes and tool execution with CLI/tests.

## What Exactly Changed from v1.0.0?

| Area | v1.0.0 | v2.0.0 | Practical impact |
| --- | --- | --- | --- |
| Server bootstrap | Config file drives registration | Routes drive registration | Registration is now explicit and local to route files |
| Transport | Streamable HTTP + SSE legacy paths | Streamable HTTP only | Remove SSE URL usage and adapter settings |
| Endpoint capabilities | Config/env style toggles | Route builder method calls | Capability intent is visible in code review |
| Tool discovery source | Config-registered tools | Endpoint-registered tools | `mcp:test-tool` follows route registrations |
| Route concerns (domain/middleware) | Config keys | Native Laravel/Lumen route groups | Reuse existing routing patterns directly |

## Config-to-Route Mapping

| v1.0.0 config key | v2.0.0 route API |
| --- | --- |
| `server.name` | `->setServerInfo(name: '...')` |
| `server.version` | `->setServerInfo(version: '...')` |
| `server.*` (combined) | `->setServerInfo(name: ..., version: ...)` (+ optional metadata: `title`, `description`, `websiteUrl`, `icons`, `instructions`) |
| `tools` | `->tools([...])` |
| `resources` | `->resources([...])` |
| `resource_templates` | `->resourceTemplates([...])` |
| `prompts` | `->prompts([...])` |
| `tool_capabilities.list_changed` | `->toolListChanged(true)` |
| `domain` | `Route::domain('api.example.com')->group(function () { Route::mcp(...); })` |
| `N/A in v1.0.0 (new in v2 resources capabilities)` | `->resourcesSubscribe(true)->resourcesListChanged(true)` |
| `N/A in v1.0.0 (new in v2 prompts capabilities)` | `->promptsListChanged(true)` |
| `tools_list.page_size` | `->toolsPageSize(50)` |
| `default_path` | `Route::mcp('/your-path')` path argument |
| `middlewares` | `Route::middleware([...])->group(...)` |
| `server_provider`, `sse_adapter`, `adapters` | Removed (no replacement needed) |
| `enabled` | Removed (control registration using your own route organization) |

## Tutorial: Migrate a Laravel App Step by Step

### Step 1. Remove v1.0.0 bootstrap assumptions

Delete or stop relying on:
- `config/mcp-server.php`
- deployment logic that publishes or reads package MCP config
- SSE endpoint assumptions (`/sse`, `/message`)

Why: v2 does not read package MCP config and does not expose SSE transport.

### Step 2. Register a minimal endpoint first

Start with the smallest working route. This reduces migration risk and gives you a quick smoke test target.

```php
use Illuminate\Support\Facades\Route;
use App\MCP\Tools\MyTool;

Route::mcp('/mcp')
    ->tools([MyTool::class]);
```

Why: once this route is visible in `route:list`, your migration has a concrete base.

### Step 3. Add server identity and route concerns

Move old server identity, middleware, and domain behavior into route files:

Set server identity with `setServerInfo(...)` in your route definition:

```php
use Illuminate\Support\Facades\Route;
use App\MCP\Tools\MyTool;

Route::domain('api.example.com')
    ->middleware(['auth:sanctum', 'throttle:100,1'])
    ->group(function (): void {
        Route::mcp('/mcp')
            ->setServerInfo(
                name: 'Acme MCP Server',
                version: '2.0.0',
                title: 'Acme MCP',
                description: 'Acme tool and data gateway',
                websiteUrl: 'https://example.com/mcp',
                icons: [
                    ['src' => 'https://example.com/icon.png', 'mimeType' => 'image/png', 'sizes' => ['512x512'], 'theme' => 'dark'],
                ],
                instructions: 'Call tools/list before tools/call.',
            )
            ->tools([MyTool::class]);
    });
```

Why: route-level composition replaces config-level composition in v2.

### Step 4. Add resources, templates, prompts, and capabilities intentionally

Enable only what your endpoint actually needs.

```php
use Illuminate\Support\Facades\Route;
use App\MCP\Tools\MyTool;
use App\MCP\Resources\MyResource;
use App\MCP\ResourceTemplates\MyTemplate;
use App\MCP\Prompts\MyPrompt;

Route::mcp('/mcp')
    ->setServerInfo(
        name: 'Acme MCP Server',
        version: '2.0.0',
        title: 'Acme MCP',
        description: 'Acme tool and data gateway',
        websiteUrl: 'https://example.com/mcp',
        icons: [
            ['src' => 'https://example.com/icon.png', 'mimeType' => 'image/png', 'sizes' => ['512x512'], 'theme' => 'dark'],
        ],
        instructions: 'Call tools/list before tools/call.',
    )
    ->tools([MyTool::class])
    ->resources([MyResource::class])
    ->resourceTemplates([MyTemplate::class])
    ->prompts([MyPrompt::class])
    ->toolListChanged(false)
    ->resourcesSubscribe(false)
    ->resourcesListChanged(false)
    ->promptsListChanged(false)
    ->toolsPageSize(50);
```

Why: explicit values make capability intent clear, predictable, and reviewable.

### Step 5. Migrate tool interfaces

If your tools still include legacy transport methods, run:

```bash
php artisan mcp:migrate-tools
```

The command migrates v1.0.0-style tool signatures, renames legacy v1.0 getter methods, and removes obsolete `messageType()` usage while preserving backups by default.
It does not remove optional `isStreaming()` methods.

Manual compatibility reference:

```php
// Required removals for v2 compatibility:
// - use OPGG\LaravelMcpServer\Enums\ProcessMessageType;
// - public function messageType(): ProcessMessageType { ... }
//
// Optional cleanup (runtime no longer uses this method):
// - public function isStreaming(): bool { ... }
```

### Step 6. Update MCP clients to the new route path

Point your MCP client to the route path you registered (for example, `/mcp`).

Important transport behavior in v2:
- MCP uses Streamable HTTP only.
- `POST /path` handles JSON-RPC requests.
- `GET /path` returns HTTP 405 by design.

If routes are in `routes/web.php`, exclude MCP POST requests from CSRF protection or register the endpoint in an API route context.

### Step 7. Verify end to end

Run:

```bash
php artisan route:list | grep mcp
php artisan mcp:test-tool --list --endpoint=/mcp
vendor/bin/pest
vendor/bin/phpstan analyse
```

Expected results:
- `route:list` shows your MCP path.
- `mcp:test-tool --list --endpoint=/mcp` resolves tools from that endpoint.
- test and static analysis pipelines pass.

## Before and After (Condensed)

### v1.0.0 (config-driven)

```php
// config/mcp-server.php (removed in v2)
return [
    'enabled' => true,
    'server' => [
        'name' => 'Acme MCP Server',
        'version' => '2.0.0',
    ],
    'server_provider' => 'streamable_http',
    'default_path' => 'mcp',
    'middlewares' => ['auth:sanctum'],
    'tools' => [
        App\MCP\Tools\MyTool::class,
    ],
];
```

### v2.0.0 (route-driven)

```php
use Illuminate\Support\Facades\Route;
use App\MCP\Tools\MyTool;
use App\MCP\Resources\MyResource;
use App\MCP\ResourceTemplates\MyTemplate;
use App\MCP\Prompts\MyPrompt;

Route::middleware(['auth:sanctum', 'throttle:100,1'])
    ->group(function (): void {
        Route::mcp('/mcp')
            ->setServerInfo(
                name: 'Acme MCP Server',
                version: '2.0.0',
                title: 'Acme MCP',
                description: 'Acme tool and data gateway',
                websiteUrl: 'https://example.com/mcp',
                icons: [
                    ['src' => 'https://example.com/icon.png', 'mimeType' => 'image/png', 'sizes' => ['512x512'], 'theme' => 'dark'],
                ],
                instructions: 'Call tools/list before tools/call.',
            )
            ->tools([MyTool::class])
            ->resources([MyResource::class])
            ->resourceTemplates([MyTemplate::class])
            ->prompts([MyPrompt::class])
            ->toolListChanged(false)
            ->resourcesSubscribe(false)
            ->resourcesListChanged(false)
            ->promptsListChanged(false)
            ->toolsPageSize(50);
    });
```

## Lumen Migration Note

Lumen does not expose the `Route::mcp()` macro. Use:

```php
use OPGG\LaravelMcpServer\Routing\McpRoute;
use App\MCP\Tools\MyTool;
use App\MCP\Resources\MyResource;
use App\MCP\ResourceTemplates\MyTemplate;
use App\MCP\Prompts\MyPrompt;

McpRoute::register('/mcp')
    ->setServerInfo(
        name: 'Acme MCP Server',
        version: '2.0.0',
        title: 'Acme MCP',
        description: 'Acme tool and data gateway',
        websiteUrl: 'https://example.com/mcp',
        icons: [
            ['src' => 'https://example.com/icon.png', 'mimeType' => 'image/png', 'sizes' => ['512x512'], 'theme' => 'dark'],
        ],
        instructions: 'Call tools/list before tools/call.',
    )
    ->tools([MyTool::class])
    ->resources([MyResource::class])
    ->resourceTemplates([MyTemplate::class])
    ->prompts([MyPrompt::class])
    ->toolListChanged(false)
    ->resourcesSubscribe(false)
    ->resourcesListChanged(false)
    ->promptsListChanged(false)
    ->toolsPageSize(50);
```

If you need middleware in Lumen, wrap `McpRoute::register(...)` inside router groups (for example `$router->group(['middleware' => ['auth:api']], fn () => ...)`).

After these checks pass, your project is fully migrated to the v2.0.0 routing model.
